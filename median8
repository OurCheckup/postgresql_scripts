--select medianjob8();
--select * from median where user_id = 534
--select * from subscriber_profile where user_id = 484
--select * from device_agg_final_monthly where user_id=524
--select * from public."Quaterly" where user_id = 484
--select * from med where user_id = 411
--delete from device_agg_final_daily
CREATE OR REPLACE FUNCTION medianjob8()
   RETURNS void as $$
   
   Declare "median" varchar(30);
   Declare "mode" varchar(30);
   Declare "device_agg_final_weekly" varchar(30);
   Declare "med" varchar(30);
   Declare "mod" varchar(30);
   Declare "device_agg_final_monthly" varchar(30);
   Declare "med3" varchar(30);
   Declare "mod3" varchar(30);
   Declare "device_agg_final_daily" varchar(30);
   
   
   begin
   --median
   

   drop table median;
 create table  median  As
   select user_id,device_id,week,ROUND(AVG(sys), 2) AS median_sys,
       ROUND(AVG(dia), 2) AS median_dia,ROUND(AVG(pul), 2) AS median_pul,ROUND(AVG(body_weight), 2) AS median_body_weight,ROUND(AVG(bmi), 2) AS median_bmi,
ROUND(AVG(skeleton), 2) AS median_skeleton,ROUND(AVG(fat), 2) AS median_fat,ROUND(AVG(muscle ), 2) AS median_muscle,ROUND(AVG(visceral_fat ), 2) AS median_visceral_fat,ROUND(AVG(bmr), 2) AS median_bmr,ROUND(AVG(bodyage), 2) AS median_bodyage,ROUND(AVG(moisture), 2) AS median_moisture,ROUND(AVG(heart_rate), 2) AS median_heart_rate,ROUND(AVG(heart_rate_real_time), 2) AS median_heart_rate_real_time,ROUND(AVG(blood_pressure_up), 2) AS median_blood_pressure_up,ROUND(AVG(blood_pressure_down), 2) AS median_blood_pressure_down,ROUND(AVG(blood_oxygen), 2) AS median_blood_oxygen,ROUND(AVG(blood_oxygen_real_time), 2) AS median_blood_oxygen_real_time,ROUND(AVG(ecg), 2) AS median_ecg,ROUND(AVG(steps), 2) AS median_steps,ROUND(AVG(calories_burt), 2) AS median_calories_burt,ROUND(AVG(spo2), 2) AS median_spo2,ROUND(AVG(sleep_minutes), 2) AS median_sleep_minutes,ROUND(AVG(sleep_hours), 2) AS median_sleep_hours,ROUND(AVG(deep_sleep), 2) AS median_deep_sleep,ROUND(AVG(shallow_sleep), 2) AS median_shallow_sleep
    FROM (SELECT user_id,device_id,week,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep
	  FROM ( 
      SELECT user_id,device_id,week,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep,
           COUNT(*) OVER(Partition BY user_id,device_id) AS row_count1,
	     
                   ROW_NUMBER() OVER(Partition BY user_id,device_id ) AS row_number1
	      
 FROM public."device_agg_weekly1" where 
		  sys  <> 0 or dia <> 0 or pul <> 0 or body_weight <> 0 or bmi <> 0 or skeleton <> 0 or fat <> 0 or muscle <> 0 or visceral_fat <> 0 or bmr <>0 or bodyage <>0 or moisture<>0 or heart_rate<>0 or heart_rate_real_time <> 0 or blood_pressure_up <>0
 or blood_pressure_down <> 0 or blood_oxygen <> 0 or blood_oxygen_real_time <> 0 or ecg <> 0 or steps <> 0 or calories_burt <> 0 or spo2 <> 0 or sleep_minutes<> 0 or sleep_hours <> 0 or deep_sleep <> 0 or shallow_sleep <> 0 
		  group by user_id,device_id,week,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep
  ) x 
		  
		  --where
					  -- row_number1 IN ((row_count1 + 1)/2, (row_count1 + 2)/2)

		group by user_id,device_id,week,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep
)  y


group by user_id,device_id,week;

drop table mode;
create table  mode  As   
SELECT user_id,device_id,week,
		
		MODE() WITHIN GROUP (ORDER BY sys) AS mode_sys,
        MODE() WITHIN GROUP (ORDER BY dia) AS mode_dia,
		MODE() WITHIN GROUP (ORDER BY pul) AS mode_pul,
		MODE() WITHIN GROUP (ORDER BY body_weight) AS mode_body_weight,
		MODE() WITHIN GROUP (ORDER BY bmi) AS mode_bmi,
		MODE() WITHIN GROUP (ORDER BY skeleton) AS mode_skeleton,
		MODE() WITHIN GROUP (ORDER BY fat) AS mode_fat,
		MODE() WITHIN GROUP (ORDER BY muscle) AS mode_muscle,
		MODE() WITHIN GROUP (ORDER BY moisture) AS mode_moisture,
		MODE() WITHIN GROUP (ORDER BY visceral_fat) AS mode_visceral_fat,
		MODE() WITHIN GROUP (ORDER BY bmr) AS mode_bmr,
		MODE() WITHIN GROUP (ORDER BY bodyage) AS mode_bodyage,
		MODE() WITHIN GROUP (ORDER BY heart_rate) AS mode_heart_rate,
		MODE() WITHIN GROUP (ORDER BY heart_rate_real_time) AS mode_heart_rate_real_time,
		MODE() WITHIN GROUP (ORDER BY blood_pressure_up) AS mode_blood_pressure_up,
        MODE() WITHIN GROUP (ORDER BY blood_pressure_down) AS mode_blood_pressure_down,
		MODE() WITHIN GROUP (ORDER BY blood_oxygen) AS mode_blood_oxygen,
		MODE() WITHIN GROUP (ORDER BY blood_oxygen_real_time) AS mode_blood_oxygen_real_time,
		MODE() WITHIN GROUP (ORDER BY ecg) AS mode_ecg,
		MODE() WITHIN GROUP (ORDER BY steps) AS mode_steps,
		MODE() WITHIN GROUP (ORDER BY calories_burt) AS mode_calories_burt,
		MODE() WITHIN GROUP (ORDER BY spo2) AS mode_spo2,
		MODE() WITHIN GROUP (ORDER BY sleep_minutes) AS mode_sleep_minutes,
		MODE() WITHIN GROUP (ORDER BY sleep_hours) AS mode_sleep_hours,
		MODE() WITHIN GROUP (ORDER BY deep_sleep) AS mode_deep_sleep,
		MODE() WITHIN GROUP (ORDER BY shallow_sleep) AS mode_shallow_sleep
		  FROM public."device_agg_weekly1" WHERE   sys  <> 0 or dia <> 0 or pul <> 0 or body_weight <> 0 or bmi <> 0 or skeleton <> 0 or fat <> 0 or muscle <> 0 or visceral_fat <> 0 or bmr <>0 or bodyage <>0 or moisture<>0 or heart_rate<>0 or heart_rate_real_time <> 0 or blood_pressure_up <>0
 or blood_pressure_down <> 0 or blood_oxygen <> 0 or blood_oxygen_real_time <> 0 or ecg <> 0 or steps <> 0 or calories_burt <> 0 or spo2 <> 0 or sleep_minutes<> 0 or sleep_hours <> 0 or deep_sleep <> 0 or shallow_sleep <> 0 
 group by user_id,device_id,week;
 

--select *  from device_agg_final_weekly 

insert into device_agg_final_weekly   
select w.user_id,w.week, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep   from public.device_agg_weekly as w
inner  join median as m  on w.user_id=m.user_id and w.device_id=m.device_id and w.week=m.week
inner  join mode as mo on mo.user_id=w.user_id and mo.device_id=w.device_id and mo.week=w.week  where 
w.user_id not in (select distinct user_id from device_agg_final_weekly)
		 --select * from public.device_agg_weekly where user_id = 411 and week = '20-2019'
group by w.user_id,w.week, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep;
insert into device_agg_final_weekly   
select w.user_id,w.week, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep   from public.device_agg_weekly as w
inner  join median as m  on w.user_id=m.user_id and w.device_id=m.device_id and w.week=m.week
inner  join mode as mo on mo.user_id=w.user_id and mo.device_id=w.device_id and mo.week=w.week  where 
w.user_id  in (select distinct user_id from device_agg_final_weekly) and w.week not in(select distinct week from device_agg_final_weekly)
and w.device_id not in(select distinct device_id from device_agg_final_weekly)
		 --select * from public.device_agg_weekly where user_id = 411 and week = '20-2019'
group by w.user_id,w.week, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep;
--monthly
drop table med;
create table  med  As 
select month,user_id,device_id,ROUND(AVG(sys), 2) AS median_sys,
       ROUND(AVG(dia), 2) AS median_dia,ROUND(AVG(pul), 2) AS median_pul,ROUND(AVG(body_weight), 2) AS median_body_weight,ROUND(AVG(bmi), 2) AS median_bmi,
ROUND(AVG(skeleton), 2) AS median_skeleton,ROUND(AVG(fat), 2) AS median_fat,ROUND(AVG(muscle ), 2) AS median_muscle,ROUND(AVG(visceral_fat ), 2) AS median_visceral_fat,ROUND(AVG(bmr), 2) AS median_bmr,ROUND(AVG(bodyage), 2) AS median_bodyage,ROUND(AVG(moisture), 2) AS median_moisture,ROUND(AVG(heart_rate), 2) AS median_heart_rate,ROUND(AVG(heart_rate_real_time), 2) AS median_heart_rate_real_time,ROUND(AVG(blood_pressure_up), 2) AS median_blood_pressure_up,ROUND(AVG(blood_pressure_down), 2) AS median_blood_pressure_down,ROUND(AVG(blood_oxygen), 2) AS median_blood_oxygen,ROUND(AVG(blood_oxygen_real_time), 2) AS median_blood_oxygen_real_time,ROUND(AVG(ecg), 2) AS median_ecg,ROUND(AVG(steps), 2) AS median_steps,ROUND(AVG(calories_burt), 2) AS median_calories_burt,ROUND(AVG(spo2), 2) AS median_spo2,ROUND(AVG(sleep_minutes), 2) AS median_sleep_minutes,ROUND(AVG(sleep_hours), 2) AS median_sleep_hours,ROUND(AVG(deep_sleep), 2) AS median_deep_sleep,ROUND(AVG(shallow_sleep), 2) AS median_shallow_sleep
      FROM (SELECT month,user_id,device_id,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep
	  FROM ( 
      SELECT month,user_id,device_id,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep,
          COUNT(*)
 OVER(Partition BY user_id,device_id) AS row_count1,
	     
                   ROW_NUMBER() OVER(Partition BY user_id,device_id ) AS row_number1

           
 FROM public."device_agg_monthly1"
	   
    WHERE   sys  <> 0 or dia <> 0 or pul <> 0 or body_weight <> 0 or bmi <> 0 or skeleton <> 0 or fat <> 0 or muscle <> 0 or visceral_fat <> 0 or bmr <>0 or bodyage <>0 or moisture<>0 or heart_rate<>0 or heart_rate_real_time <> 0 or blood_pressure_up <>0
 or blood_pressure_down <> 0 or blood_oxygen <> 0 or blood_oxygen_real_time <> 0 or ecg <> 0 or steps <> 0 or calories_burt <> 0 or spo2 <> 0 or sleep_minutes<> 0 or sleep_hours <> 0 or deep_sleep <> 0 or shallow_sleep <> 0 
		  group by month,user_id,device_id,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep
  ) x  
--WHERE row_number1 IN ((row_count1 + 1)/2, (row_count1 + 2)/2)                                  
      

		group by month,user_id,device_id,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep
)  y	
group by month,user_id,device_id;

drop table mod;
create table public."mod" AS
SELECT user_id,device_id,month,
		
		MODE() WITHIN GROUP (ORDER BY sys) AS mode_sys,
        MODE() WITHIN GROUP (ORDER BY dia) AS mode_dia,
		MODE() WITHIN GROUP (ORDER BY pul) AS mode_pul,
		MODE() WITHIN GROUP (ORDER BY body_weight) AS mode_body_weight,
		MODE() WITHIN GROUP (ORDER BY bmi) AS mode_bmi,
		MODE() WITHIN GROUP (ORDER BY skeleton) AS mode_skeleton,
		MODE() WITHIN GROUP (ORDER BY fat) AS mode_fat,
		MODE() WITHIN GROUP (ORDER BY muscle) AS mode_muscle,
		MODE() WITHIN GROUP (ORDER BY moisture) AS mode_moisture,
		MODE() WITHIN GROUP (ORDER BY visceral_fat) AS mode_visceral_fat,
		MODE() WITHIN GROUP (ORDER BY bmr) AS mode_bmr,
		MODE() WITHIN GROUP (ORDER BY bodyage) AS mode_bodyage,
		MODE() WITHIN GROUP (ORDER BY heart_rate) AS mode_heart_rate,
		MODE() WITHIN GROUP (ORDER BY heart_rate_real_time) AS mode_heart_rate_real_time,
		
		MODE() WITHIN GROUP (ORDER BY blood_pressure_up) AS mode_blood_pressure_up,
        MODE() WITHIN GROUP (ORDER BY blood_pressure_down) AS mode_blood_pressure_down,
		MODE() WITHIN GROUP (ORDER BY blood_oxygen) AS mode_blood_oxygen,
		MODE() WITHIN GROUP (ORDER BY blood_oxygen_real_time) AS mode_blood_oxygen_real_time,
		MODE() WITHIN GROUP (ORDER BY ecg) AS mode_ecg,
		MODE() WITHIN GROUP (ORDER BY steps) AS mode_steps,
		MODE() WITHIN GROUP (ORDER BY calories_burt) AS mode_calories_burt,
		MODE() WITHIN GROUP (ORDER BY spo2) AS mode_spo2,
		MODE() WITHIN GROUP (ORDER BY sleep_minutes) AS mode_sleep_minutes,
		MODE() WITHIN GROUP (ORDER BY sleep_hours) AS mode_sleep_hours,
		MODE() WITHIN GROUP (ORDER BY deep_sleep) AS mode_deep_sleep,
		MODE() WITHIN GROUP (ORDER BY shallow_sleep) AS mode_shallow_sleep
		
		  FROM public."device_agg_monthly1" where sys  <> 0 or dia <> 0 or pul <> 0 or body_weight <> 0 or bmi <> 0 or skeleton <> 0 or fat <> 0 or muscle <> 0 or visceral_fat <> 0 or bmr <>0 or bodyage <>0 or moisture<>0 or heart_rate<>0 or heart_rate_real_time <> 0 or blood_pressure_up <>0
 or blood_pressure_down <> 0 or blood_oxygen <> 0 or blood_oxygen_real_time <> 0 or ecg <> 0 or steps <> 0 or calories_burt <> 0 or spo2 <> 0 or sleep_minutes<> 0 or sleep_hours <> 0 or deep_sleep <> 0 or shallow_sleep <> 0 
 group by user_id,device_id,month;
 

insert into  device_agg_final_monthly 
Select w.user_id,w.month, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep  from public.device_agg_monthly as w
inner  join med as m  on w.user_id=m.user_id and w.device_id=m.device_id and w.Month=m.Month
inner  join mod as mo on mo.user_id=w.user_id and mo.device_id=w.device_id and mo.Month=w.Month where 
w.user_id not in (select distinct user_id from device_agg_final_monthly)  
group by w.user_id,w.month, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep;
insert into  device_agg_final_monthly 
Select w.user_id,w.month, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep  from public.device_agg_monthly as w
inner  join med as m  on w.user_id=m.user_id and w.device_id=m.device_id and w.Month=m.Month
inner  join mod as mo on mo.user_id=w.user_id and mo.device_id=w.device_id and mo.Month=w.Month where 
w.user_id  in (select distinct user_id from device_agg_final_monthly)  and w.Month not in (select distinct month from device_agg_final_monthly)
and w.device_id not in (select distinct device_id from device_agg_final_monthly)
group by w.user_id,w.month, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep;
--daily
--delete from med3
drop table public."med3";
create table  public."med3"  As  
select day,user_id,device_id,ROUND(AVG(sys), 2) AS median_sys,
       ROUND(AVG(dia), 2) AS median_dia,ROUND(AVG(pul), 2) AS median_pul,ROUND(AVG(body_weight), 2) AS median_body_weight,ROUND(AVG(bmi), 2) AS median_bmi,
ROUND(AVG(skeleton), 2) AS median_skeleton,ROUND(AVG(fat), 2) AS median_fat,ROUND(AVG(muscle ), 2) AS median_muscle,ROUND(AVG(visceral_fat ), 2) AS median_visceral_fat,ROUND(AVG(bmr), 2) AS median_bmr,ROUND(AVG(bodyage), 2) AS median_bodyage,ROUND(AVG(moisture), 2) AS median_moisture,ROUND(AVG(heart_rate), 2) AS median_heart_rate,ROUND(AVG(heart_rate_real_time), 2) AS median_heart_rate_real_time,ROUND(AVG(blood_pressure_up), 2) AS median_blood_pressure_up,ROUND(AVG(blood_pressure_down), 2) AS median_blood_pressure_down,ROUND(AVG(blood_oxygen), 2) AS median_blood_oxygen,ROUND(AVG(blood_oxygen_real_time), 2) AS median_blood_oxygen_real_time,ROUND(AVG(ecg), 2) AS median_ecg,ROUND(AVG(steps), 2) AS median_steps,ROUND(AVG(calories_burt), 2) AS median_calories_burt,ROUND(AVG(spo2), 2) AS median_spo2,ROUND(AVG(sleep_minutes), 2) AS median_sleep_minutes,ROUND(AVG(sleep_hours), 2) AS median_sleep_hours,ROUND(AVG(deep_sleep), 2) AS median_deep_sleep,ROUND(AVG(shallow_sleep), 2) AS median_shallow_sleep
     FROM (SELECT day,user_id,device_id,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep
	  FROM ( 
      SELECT day,user_id,device_id,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep,
          COUNT(*)
 OVER(Partition BY user_id,device_id) AS row_count1,
	     
                   ROW_NUMBER() OVER(Partition BY user_id,device_id ) AS row_number1

           
 FROM public."device_agg_daily1" WHERE 
		  sys  <> 0 or dia <> 0 or pul <> 0 or body_weight <> 0 or bmi <> 0 or skeleton <> 0 or fat <> 0 or muscle <> 0 or visceral_fat <> 0 or bmr <>0 or bodyage <>0 or moisture<>0 or heart_rate<>0 or heart_rate_real_time <> 0 or blood_pressure_up <>0
 or blood_pressure_down <> 0 or blood_oxygen <> 0 or blood_oxygen_real_time <> 0 or ecg <> 0 or steps <> 0 or calories_burt <> 0 or spo2 <> 0 or sleep_minutes<> 0 or sleep_hours <> 0 or deep_sleep <> 0 or shallow_sleep <> 0 
		  group by day,user_id,device_id,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep
  ) x 
--WHERE row_number1 IN ((row_count1 + 1)/2, (row_count1 + 2)/2)                                  
      

		group by day,user_id,device_id,sys,dia,pul,body_weight,bmi,skeleton,fat,muscle,visceral_fat,bmr,bodyage,moisture,heart_rate,heart_rate_real_time,blood_pressure_up,
blood_pressure_down,blood_oxygen,blood_oxygen_real_time,ecg,steps,calories_burt,spo2,sleep_minutes,sleep_hours,deep_sleep,shallow_sleep
)  y 
group by day,user_id,device_id;


--delete from mod3
drop table public."mod3";
create table  public."mod3"  As
SELECT user_id,device_id,day,
		
		MODE() WITHIN GROUP (ORDER BY sys) AS mode_sys,
        MODE() WITHIN GROUP (ORDER BY dia) AS mode_dia,
		MODE() WITHIN GROUP (ORDER BY pul) AS mode_pul,
		MODE() WITHIN GROUP (ORDER BY body_weight) AS mode_body_weight,
		MODE() WITHIN GROUP (ORDER BY bmi) AS mode_bmi,
		MODE() WITHIN GROUP (ORDER BY skeleton) AS mode_skeleton,
		MODE() WITHIN GROUP (ORDER BY fat) AS mode_fat,
		MODE() WITHIN GROUP (ORDER BY muscle) AS mode_muscle,
		MODE() WITHIN GROUP (ORDER BY moisture) AS mode_moisture,
		MODE() WITHIN GROUP (ORDER BY visceral_fat) AS mode_visceral_fat,
		MODE() WITHIN GROUP (ORDER BY bmr) AS mode_bmr,
		MODE() WITHIN GROUP (ORDER BY bodyage) AS mode_bodyage,
		MODE() WITHIN GROUP (ORDER BY heart_rate) AS mode_heart_rate,
		MODE() WITHIN GROUP (ORDER BY heart_rate_real_time) AS mode_heart_rate_real_time,
		
		MODE() WITHIN GROUP (ORDER BY blood_pressure_up) AS mode_blood_pressure_up,
        MODE() WITHIN GROUP (ORDER BY blood_pressure_down) AS mode_blood_pressure_down,
		MODE() WITHIN GROUP (ORDER BY blood_oxygen) AS mode_blood_oxygen,
		MODE() WITHIN GROUP (ORDER BY blood_oxygen_real_time) AS mode_blood_oxygen_real_time,
		MODE() WITHIN GROUP (ORDER BY ecg) AS mode_ecg,
		MODE() WITHIN GROUP (ORDER BY steps) AS mode_steps,
		MODE() WITHIN GROUP (ORDER BY calories_burt) AS mode_calories_burt,
		MODE() WITHIN GROUP (ORDER BY spo2) AS mode_spo2,
		MODE() WITHIN GROUP (ORDER BY sleep_minutes) AS mode_sleep_minutes,
		MODE() WITHIN GROUP (ORDER BY sleep_hours) AS mode_sleep_hours,
		MODE() WITHIN GROUP (ORDER BY deep_sleep) AS mode_deep_sleep,
		MODE() WITHIN GROUP (ORDER BY shallow_sleep) AS mode_shallow_sleep
		
		 FROM public."device_agg_daily1"  where
		  sys  <> 0 or dia <> 0 or pul <> 0 or body_weight <> 0 or bmi <> 0 or skeleton <> 0 or fat <> 0 or muscle <> 0 or visceral_fat <> 0 or bmr <>0 or bodyage <>0 or moisture<>0 or heart_rate<>0 or heart_rate_real_time <> 0 or blood_pressure_up <>0
 or blood_pressure_down <> 0 or blood_oxygen <> 0 or blood_oxygen_real_time <> 0 or ecg <> 0 or steps <> 0 or calories_burt <> 0 or spo2 <> 0 or sleep_minutes<> 0 or sleep_hours <> 0 or deep_sleep <> 0 or shallow_sleep <> 0 
 group by user_id,device_id,day;
 
 
 --delete from device_agg_final_daily

insert into  "device_agg_final_daily" 
select w.user_id,w.day, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep  from public.device_agg_daily as w
inner  join med3 as m  on w.user_id=m.user_id and w.device_id=m.device_id and w.day=m.daY
inner  join mod3 as mo on mo.user_id=w.user_id and mo.device_id=w.device_id and mo.day=w.day where w.user_id not in (select distinct user_id from device_agg_final_daily)
group by w.user_id,w.day, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep;
insert into  "device_agg_final_daily" 
select w.user_id,w.day, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep  from public.device_agg_daily as w
inner  join med3 as m  on w.user_id=m.user_id and w.device_id=m.device_id and w.day=m.daY
inner  join mod3 as mo on mo.user_id=w.user_id and mo.device_id=w.device_id and mo.day=w.day where
w.user_id  in (select distinct user_id from device_agg_final_daily) and w.day not in (select distinct day from device_agg_final_daily)
and w.device_id not in (select distinct device_id from device_agg_final_daily)
group by w.user_id,w.day, w.device_id,w.sys ,
w.dia ,
w.pul ,
w.body_weight ,
w.bmi ,
w.skeleton ,
w.fat ,
w.muscle ,
w.moisture ,
w.visceral_fat ,
w.bmr ,
w.bodyage ,
w.heart_rate , 
w.heart_rate_real_time ,
w.blood_pressure_up ,
w.blood_pressure_down ,
w.blood_oxygen ,
w.blood_oxygen_real_time ,
w.ecg ,
w.steps ,
w.calories_burt ,
w.spo2 ,
w.sleep_minutes ,
w.sleep_hours ,
w.deep_sleep ,
w.shallow_sleep,
w.min_sys ,
w.min_dia ,
w.min_pul ,
w.min_body_weight ,
w.min_skeleton ,
w.min_fat ,
w.min_muscle ,
w.min_moisture ,
w.min_visceral_fat ,
w.min_bmr ,
w.min_bodyage ,
w.min_heart_rate , 
w.min_heart_rate_real_time ,
w.min_blood_pressure_up ,
w.min_blood_pressure_down ,
w.min_blood_oxygen ,
w.min_blood_oxygen_real_time ,
w.min_ecg ,
w.min_steps ,
w.min_calories_burt ,
w.min_spo2 ,
w.min_sleep_minutes ,
w.min_sleep_hours ,
w.min_deep_sleep ,
w.min_shallow_sleep,
w.max_sys ,
w.max_dia ,
w.max_pul ,
w.max_body_weight ,
w.max_bmi ,
w.max_skeleton ,
w.max_fat ,
w.max_muscle ,
w.max_moisture ,
w.max_visceral_fat ,
w.max_bmr ,
w.max_bodyage ,
w.max_heart_rate , 
w.max_heart_rate_real_time ,
w.max_blood_pressure_up ,
w.max_blood_pressure_down ,
w.max_blood_oxygen ,
w.max_blood_oxygen_real_time ,
w.max_ecg ,
w.max_steps ,
w.max_calories_burt ,
w.max_spo2 ,
w.max_sleep_minutes ,
w.max_sleep_hours ,
w.max_deep_sleep ,
w.max_shallow_sleep,
m.median_sys ,
m.median_dia ,
m.median_body_weight ,
m.median_bmi ,
m.median_skeleton ,
m.median_fat ,
m.median_muscle ,
m.median_moisture ,
m.median_visceral_fat ,
m.median_bmr ,
m.median_bodyage ,
m.median_heart_rate , 
m.median_heart_rate_real_time ,
m.median_blood_pressure_up ,
m.median_blood_pressure_down ,
m.median_blood_oxygen ,
m.median_blood_oxygen_real_time ,
m.median_ecg ,
m.median_steps ,
m.median_calories_burt ,
m.median_spo2 ,
m.median_sleep_minutes ,
m.median_sleep_hours ,
m.median_deep_sleep ,
m.median_shallow_sleep,
mo.mode_sys ,
mo.mode_dia ,
mo.mode_pul ,
mo.mode_body_weight ,
mo.mode_bmi ,
mo.mode_skeleton ,
mo.mode_fat ,
mo.mode_muscle ,
mo.mode_moisture ,
mo.mode_visceral_fat ,
mo.mode_bmr ,
mo.mode_bodyage ,
mo.mode_heart_rate , 
mo.mode_heart_rate_real_time ,
mo.mode_blood_pressure_up ,
mo.mode_blood_pressure_down ,
mo.mode_blood_oxygen ,
mo.mode_blood_oxygen_real_time ,
mo.mode_ecg ,
mo.mode_steps ,
mo.mode_calories_burt ,
mo.mode_spo2 ,
mo.mode_sleep_minutes ,
mo.mode_sleep_hours ,
mo.mode_deep_sleep ,
mo.mode_shallow_sleep;


END;
$$ LANGUAGE plpgsql;



